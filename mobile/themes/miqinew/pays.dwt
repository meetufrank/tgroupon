<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>支付方式</title>

  <!--SEO Meta Tags-->
  <meta name="description" content="M-Store - Modern E-Commerce Template" />
  <meta name="keywords" content="shop, e-commerce, modern, minimalist style, responsive, online store, business, mobile, blog, bootstrap, html5, css3, jquery, js, gallery, slider, touch, creative, clean" />
  <meta name="author" content="Rokaux" />

  <!--Mobile Specific Meta Tag-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!--Favicon-->
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="icon" href="favicon.ico" type="image/x-icon">

  <!-- Google Material Icons -->
   <link href="{$ectouch_themes}/css/vendor/material-icons.min.css" rel="stylesheet" media="screen">

  <!-- Brand Icons -->
  <link href="{$ectouch_themes}/css/vendor/socicon.min.css" rel="stylesheet" media="screen">

  <!-- Bootstrap -->
  <link href="{$ectouch_themes}/css/vendor/bootstrap.min.css" rel="stylesheet" media="screen">

  <!-- Theme Styles -->
  <link href="{$ectouch_themes}/css/theme.min.css" rel="stylesheet" media="screen">

  <!-- Page Preloading -->
  <script src="{$ectouch_themes}/js/vendor/page-preloading.js"></script>

  <!-- Modernizr -->
  <script src="{$ectouch_themes}/js/vendor/modernizr.custom.js"></script>
  <style>
    #form-control .form-control{
    height: 40px;
    line-height: 1.2;
    color: #999;
    border: 1px solid #ededed;
    border-radius: 2px;
    padding: 0;
    margin-bottom: 0px;
    text-indent:2px;
    }
    #form-control .col-md-4{
    padding-left:0;
    padding-right:0;
    }
    input{
      outline:none;
    }
    .new-address{
      width:98%;
      height:40px;
      padding:0 1%;
      margin-bottom:10px;
      border: 1px solid #ededed;
    }
    .new-address::-webkit-input-placeholder {
      color:#C1C1C1; /*WebKit browsers*/
    }
    .new-address::-moz-placeholder{
      color:#C1C1C1; /*Mozilla Firefox 19+ */
    }
    .new-address-change{
      width:98%;
      height:40px;
      padding:0 1%;
      margin-bottom:10px;
      border: 1px solid red;
    }
    .new-address-change::-webkit-input-placeholder {
      color:red; /*WebKit browsers*/
    }
    .new-address-change::-moz-placeholder{
      color:red; /*Mozilla Firefox 19+ */
    }
  </style>

</head>

<!-- Body -->
<!-- Adding/Removing class ".page-preloading" is enabling/disabling background smooth page transition effect and spinner. Make sure you also added/removed link to page-preloading.js script in the <head> of the document. -->
<body class="page-preloading">

  <!-- Page Pre-Loader -->
  <div class="page-preloader">
    <div class="preloader">
      <img src="{$ectouch_themes}/img/preloader.gif" alt="Preloader">
    </div>
  </div><!-- .page-preloader -->

  <!-- Page Wrapper -->
  <div class="page-wrapper">

 <!-- 头部开始 -->
     {include file="head.dwt"}
    <!-- 头部结束 -->

    <!-- Shop Catalog -->
<section class="container">
        <!-- 快递地址 -->
        <div class="shopping-cart-1 padding-bottom-1x" style="padding:15px; margin-bottom: 30px;" id="pay_consignee">
                <div style=" border-bottom: 2px solid #ededed; margin-bottom:30px;padding-bottom: 18px; ">
                    <h4 class="text-primary">快递地址</h4>
                </div>

                   <!-- {foreach from=$consignee_list item=consignee key=sn name=address}-->
                  <div class="row pay_label" style=" padding:2px 0; margin-bottom: 10px; margin-left: 0; margin-right: 0;cursor:pointer;" onclick="checkadd({$consignee.address_id})" id="div{$consignee.address_id}">

                  <div class="col-md-6 check_box"  >
                    <label class="radio radio-inline" style="margin-right:0; padding-top: 4px;" id="label{$consignee.address_id}"  >
                     <input type="radio" name="my_co_shipping" {if $smarty.foreach.address.iteration==1}checked{/if} value="{$consignee.address_id}"  id="address{$consignee.address_id}"  >
                     </label>
                   {$consignee.province}{$consignee.city}{$consignee.district}{$consignee.address}
                  </div>
                  <div class="col-md-3">
                    收件人：{$consignee.consignee}
                  </div>
                  <div class="col-md-3">
                    联系电话：{$consignee.tel}
                  </div>

                </div>
                <!--{/foreach}-->




                   <h5 style="margin-top: 15px; margin-left: 18px;" id="address_h5"><a href="#" id="Address_Manager" class="toggle-section" style="text-decoration: underline;">新增地址</a></h5>
        </div>
</section>

<div class="container-fluid" style="height:12px; margin-bottom: 10px; background:#f4f4f4;">&nbsp;</div>
        <!-- 订单信息 -->
        <section class="container">
        <div class="shopping-cart-1" style="padding:15px; margin-bottom: 30px;">
                                    <div class="clearfix" style=" border-bottom: 2px solid #ededed; margin-bottom:30px; padding-bottom:20px;">
                                        <h4 class="text-primary pull-left">确认订单信息</h4>
                                   </div>
                                   <div class=" hidden-xs">
                                   <div class="row text-center" style="padding-bottom:20px; margin:0 0 30px 0; border-bottom: 1px solid #ededed; ">
                                        <div class="col-sm-3" style="padding-left: 0;">
                                          商品
                                        </div>
                                        <div class="col-sm-3">
                                          商品属性
                                        </div>
                                        <div class="col-sm-3">
                                          数量
                                        </div>
                                        <div class="col-sm-2">
                                          价格
                                        </div>
                                        <div class="col-sm-1">
                                          &nbsp;
                                        </div>
                                   </div>
                                    <!--{foreach from=$cart_list.goods_list item=gl}-->
                                   <div class="row text-center pc_paylist" style="padding-bottom:20px;">
                                   <input  type="hidden" value="{$gl.rec_id}"   class="pay_rec">
                                        <div class="col-sm-3">
                                            <div class="row">
                                                <div class="col-md-8 col-md-offset-2">
                                                    <a href="#" class="item-thumb">
                                                      <img class="img-responsive" src="../../{$gl.goods_thumb}" alt="{$gl.goods_name}">
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-3" style="padding-top: 3%;">
                                            <h5>{$gl.goods_name}</h5>
                                            <div>{$gl.goods_attr}</div>
                                        </div>
                                        <div class="col-sm-3" style="padding-top: 3%;">
                                            <div class="count-input" style="margin:0 auto;">
                                              <a class="incr-btn" data-action="decrease" href="#" onclick="changecart({$gl.rec_id},-1)">–</a>
                                              <input class="quantity cart_number_{$gl.rec_id}" type="text" value="{$gl.goods_number}" min="1" max="1000" name="goods_number[{$gl.rec_id}]"   readonly>
                                              <a class="incr-btn" data-action="increase" href="#" onclick="changecart({$gl.rec_id},1)">+</a>
                                            </div>
                                        </div>
                                        <div class="col-sm-2 goods_subtotal{$gl.rec_id} pc_subtotal"    style="padding-top: 3%; margin-top:7px;color: #F20000;" >
                                            {$gl.subtotal}
                                        </div>
                                        <div class="col-sm-1" style="padding-top: 3%;">
                                            <a href="#" style="display:inline-block; width:36px; height:36px; font-size: 20px; border-radius:3px; border: 2px solid #ededed;" data-toggle="tooltip" data-placement="top" title="删除" class="item-remove droplist dropcart{$gl.rec_id} " onclick="dropcart({$gl.rec_id});">
                                            <i class="material-icons delete"></i>
                                          </a>
                                        </div>
                                   </div>
                                   <!-- {/foreach} -->

                                   <div class="row text-center" style="padding-bottom:20px; margin:0; border-bottom: 1px solid #ededed; ">
                                        <div class="col-sm-3">
                                            &nbsp;
                                        </div>
                                        <div class="col-sm-3" style="padding-top: 3%;">
                                            &nbsp;
                                        </div>
                                        <div class="col-sm-3" style="padding-top: 3%;">
                                            邮费：
                                        </div>
                                        <div class="col-sm-2 come_price" style="padding-top: 3%;">
                                        ￥<span>0</span>

                                        </div>
                                        <div class="col-sm-1" style="padding-top: 3%;">
                                        &nbsp;
                                   </div>
                                   <div class="row">
                                        <div class="col-sm-3">
                                            &nbsp;
                                        </div>
                                        <div class="col-sm-3" style="padding-top: 3%;">
                                            &nbsp;
                                        </div>
                                        <div class="col-sm-3" style="padding-top: 3%;">
                                            &nbsp;
                                        </div>
                                        <div class="col-sm-3" style="padding-top: 3%;">
                                            <h5>总计：<span class="amount_pay" style="color:#f20000">{$cart_list.total.goods_price}</span></h5>
                                        </div>
                                        <div class="text-right order_ok" style="padding-right: 18px;"><a href="#" class="btn btn-primary" style="width:auto;" >确认订单</a></div>
                                   </div>
                                   </div>
                                   </div>
                                   <!--mobile-->
                                   <div class="hidden-sm hidden-md hidden-lg">

                                     <!--{foreach from=$cart_list.goods_list item=gl}-->
                                     <div class="padding-bottom-2x mobile_paylist">
                                          <div class="row">
                                          <div class="col-xs-3">
                                            <a href="#">
                                              <img class="img-responsive" src="../../{$gl.goods_thumb}" alt="{$gl.goods_name}">
                                            </a>
                                          </div>
                                          <div class="col-xs-9">
                                            {$gl.goods_name}
                                          </div>
                                          </div>
                                            <div style="margin-top:20px;padding:20px 0; border-top:1px solid #f5f5f5; border-bottom:1px solid #f5f5f5; color: #999;">{$gl.goods_attr}</div>
                                            <div class="clearfix">
                                              <div class="pull-left goods_subtotal{$gl.rec_id} mobile_subtotal" style="padding-top:15px; color: #F20000;">{$gl.subtotal}</div>
                                              <div class="pull-right">
                                                <div class="count-input" style="display:inline-block;">
                                                <a class="incr-btn" href="#" onclick="changecart({$gl.rec_id},-1)">–</a>
                                                <input class="quantity cart_number_{$gl.rec_id}" type="text" value="{$gl.goods_number}" min="1" max="1000" name="goods_number[{$gl.rec_id}]"    readonly>
                                                <a class="incr-btn" href="#" onclick="changecart({$gl.rec_id},1)">+</a>
                                                </div>
                                                <a href="#" style="display:inline-block; padding-left:6px; width:36px; height:36px; font-size: 20px; border-radius:3px; border: 2px solid #ededed;" data-toggle="tooltip" data-placement="top" title="删除" class=" droplist dropcart{$gl.rec_id}" onclick="dropcart({$gl.rec_id});">
                                                  <i class="material-icons delete"></i>
                                              </a>
                                              </div>
                                            </div>
                                  </div>

                                    <!--{/foreach}-->
                                    <!-- Item -->

                                    <div class="clearfix" style="padding-top:20px; margin:0 0 30px 0; border-top: 1px solid #ededed; ">
                                        <span>邮费：</span>
                                        <div class="pull-right come_price come_price_pc">￥<span>0</span></div>
                                    </div>
                                    <div class="clearfix" style="padding-top:20px; margin:0 0 30px 0; border-top: 1px solid #ededed; ">
                                        <h5 class="text-right">总计：<span class="amount_pay" style="color:#f20000" >{$cart_list.total.goods_price}
                                        </span></h5>
                                    </div>
                                       <div><a href="#" class="btn btn-primary order_ok" >确认订单</a></div>

                                   </div>


                              </div></section>

  </div><!-- .page-wrapper -->

  <!--底部-->
  {include file="foot.dwt"}
  <!--底部-->

  <!-- JavaScript (jQuery) libraries, plugins and custom scripts -->

  <script src="{$ectouch_themes}/js/vendor/bootstrap.min.js"></script>
  <script src="{$ectouch_themes}/js/vendor/smoothscroll.js"></script>
  <script src="{$ectouch_themes}/js/vendor/velocity.min.js"></script>
  <script src="{$ectouch_themes}/js/vendor/waves.min.js"></script>
  <script src="{$ectouch_themes}/js/vendor/icheck.min.js"></script>
  <script src="{$ectouch_themes}/js/vendor/nouislider.min.js"></script>
  <script src="{$ectouch_themes}/js/scripts.js"></script>






    <script type="text/javascript">


 $(" #pay_consignee input[type='radio']").each(function(){

                       var id= $(this).attr("id");


                       if($("#"+id).attr("checked")=="checked"){

                        $(this).parent().parent().parent().css({'font-weight':'bolder','background':"#edf7f9"});
                        var addressid=$("#"+id).val();
                            $.ajax({
                              type:"POST",
                              url:"flow.php",
                              dataType: "json",
                              data:{step:'ajax_get_price',address:addressid},
                              success: function(data){
                                           if(data.error==12){
                                                   window.location.href=data.url;
                                                   return;
                                              }
                                   $(".come_price span").text(data);
                                    jisuan();


                              }


                          });


                       }else{
                              $(".order_ok").css("display","none");
                       }

                      });
               $('input').on('ifChecked', function(event){
              //  alert(event.type + ' callback');
                //alert($(this).parent().find("input").val());
                     checkadd($(this).parent().find("input").val());
              });

 $(function(){


    if($("input:radio[name='my_co_shipping']").length > 0&& $(".pc_paylist").length>0){
              $(".order_ok").css("display","block");
        }else{
             $(".order_ok").css("display","none");
        }
      validate();

    })

    function jisuan(){
      var mobile_price=0;
      //var pc_price =0;
     var come_price= parseFloat($(".come_price_pc span").text());

      $.each($(".mobile_subtotal"),function(i) {
         mobile_price+=parseFloat($(this).children('span').text());
      });
      // $.each($(".pc_subtotal"),function(i) {
      //    pc_price+=parseFloat($(this).children('span').text());
      // });

     var sum_price=mobile_price+come_price;
     $(".amount_pay").text("￥"+sum_price.toFixed(2));


    }


  function checkadd(id){

      var address=$('#address'+id).val();


      $(" .pay_label .iradio ").removeClass('checked');
      $(" .pay_label .iradio input[type='radio']").removeAttr('checked');
      $('#address'+id).attr('checked','checked');





      $('#address'+id).parent().addClass('checked');
      $('.pay_label').css({'font-weight':'normal','background':"none"});;
      $('#div'+id).css({'font-weight':'bolder','background':"#edf7f9"});
      $.ajax({
          type:"POST",
          url:"flow.php",
          dataType: "json",
          data:{step:'ajax_get_price',address:address},
          success: function(data){
            if(data.error==12){
                               window.location.href=data.url;

                          }
               $(".come_price span").text(data);
              jisuan();

          }


      });

    }

    function validate(){
      var pc_box=$(".pc_paylist").length;
      var mobile_box=$(".mobile_paylist").length;
      if(pc_box<=1){
           $(".pc_paylist").find('.droplist').hide();
      }
      if(mobile_box<=1){
          $(".mobile_paylist").find('.droplist').hide();
      }
    }
    function changecart(rec_id,diff){

          var num = parseInt($('.cart_number_'+rec_id).val());


          var goods_number = num + Number(diff);
          if( goods_number >= 1){
            $('.cart_number_'+rec_id).val(goods_number); //更新数量
            var cartnum=document.getElementById('cart_count').innerHTML;
            document.getElementById('cart_count').innerHTML=Number(cartnum)+Number(diff);

            change_cart_number(rec_id,goods_number);
          }
        }

        function change_cart_number(rec_id, goods_number)
        {
          $.ajax({
                type:"POST",
                url:"flow.php",
                dataType: "json",
                data:{step:'ajax_update_cart',rec_id:rec_id,goods_number:goods_number},
                success: function(data){
                  console.log(data.goods_subtotal);
                   // document.getElementById('total_number').innerHTML = data.total_number;//更新数量
                  $('.goods_subtotal'+rec_id).html(data.goods_subtotal) ;//更新小计
                   jisuan();

                },
                error: function(){
                    alert("json出错");
                }
            });


        }

        function dropcart(id){
          event.preventDefault();
              $(".dropcart"+id).parents(".mobile_paylist").remove();
              $(".dropcart"+id).parents(".pc_paylist").remove();
              validate();
                $.ajax({
              url:"flow.php",
              data:{step:'drop_goods',id:id},
              dataType:"JSON",

            });
                 jisuan();
        }
function checknewaddress(){
       var user=$("input[name='consignee']").val();

       if(user==''){
           document.getElementById("newaddress").className="new-address-change";
           return false;
       }else if(user!==''){
          document.getElementById("newaddress").className="new-address";
       }


}
    //新增地址
   $('#Address_Manager').click(function(){
    var content =' <form method="post" class="checkout-form container" id="address_form"><div><input type="text" class="new-address" placeholder="收件人" name="consignee" id="newaddress"/></div>'
    +
    '<div><input type="text" style="width:98%; height:40px; padding:0 1%; margin-bottom:10px; border: 1px solid #ededed;" placeholder="手机" name="tel" /></div>'
    +
    '<div id="form-control"><div class="col-md-4 col-xs-12"><div class="form-element form-select">'+
    '<select name="province" id="province"   class="form-control" >'+
               ' <option value="0">{$lang.please_select}{$name_of_region[1]}</option>' +
                '<!-- {foreach from=$province_list item=province} -->'+
                '<option value="{$province.region_id}" {if $consignee.province eq $province.region_id}selected{/if}>{$province.region_name}</option>'+
               '<!-- {/foreach} --></select>'+
                 '</div></div><div class="col-md-4 col-xs-12"><div class="form-element form-select">'+
                 '<select name="city" id="city"  class="form-control">'+
                  '<option value="0">{$lang.please_select}{$name_of_region[2]}</option>'+
                  '<!-- {foreach from=$city_list.$sn item=city} -->'+
                  '<option value="{$city.region_id}" {if $consignee.city eq $city.region_id}selected{/if}>{$city.region_name}</option>'+
                  '<!-- {/foreach} -->'+
                 '</select>'+
                 '</div></div><div class="col-md-4 col-xs-12"><div class="form-element form-select">'+
                 '<select name="district" id="district"   class="form-control">'+
                   '<option value="0">{$lang.please_select}{$name_of_region[3]}</option>' +
                    '<!-- {foreach from=$district_list.$sn item=district} -->'+
                    '<option value="{$district.region_id}" {if $consignee.district eq $district.region_id}selected{/if}>{$district.region_name}</option>'+
                    '<!-- {/foreach} -->'+
                  '</select>'+
                 '</div></div></div>'
    +
    '<div><input type="text" style="width:98%; height:40px; padding:0 1%; margin-bottom:10px; border: 1px solid #ededed;" placeholder="详细地址" name="address"/></div>'
    +
    '<div class="text-right visible-sm visible-xs"><a href="#" style="text-decoration: underline;">读取微信地址</a></div></form>'
    ;





    layer.open({
              title: [
                '新增地址',
                'background-color:#77cde3; color:#fff;'
              ],
              content:content,
              btn: ['确认', '返回'],
              success: function(){
                       //省事件开始
                             $("#province").change(function(){
                                var id=$("#province").val();
                                $("#city").find("option").remove();
                                          $("#district").find("option").remove();
                                         $("#city").append('<option value="0">{$lang.please_select}{$name_of_region[2]}</option>');
                                         $("#district").append('<option value="0">{$lang.please_select}{$name_of_region[3]}</option>');
                                if(id!=0){
                                 $.ajax({
                                    url:"ajax_region.php",
                                    data:{ajax_province:id},
                                    dataType:"JSON",
                                    success: function(data){

                                         $.each(data,function(i){

                                             $("#city").append(
                                               ' <option value="'+data[i].region_id+'"  >'+data[i].region_name+'</option>'
                                             );


                                         });
                                         var cityid=$("#city").val();





                                    },
                                    error:function(){
                                          alert('error');
                                    }
                                  });
                                }

                            });
                        //省事件结束
                        //市事件开始
                         $("#city").change(function(){
                            var id=$("#city").val();
                            $("#district").find("option").remove();
                            $("#district").append('<option value="0" selected>{$lang.please_select}{$name_of_region[3]}</option>');
                            if(id!=0){
                             $.ajax({
                                url:"ajax_region.php",
                                data:{ajax_province:id},
                                dataType:"JSON",
                                success: function(data){

                                     $.each(data,function(i){

                                         $("#district").append(
                                           ' <option value="'+data[i].region_id+'" >'+data[i].region_name+'</option>'
                                         );


                                     });

                                },
                                error:function(){
                                      alert('error');
                                }
                              });
                            }

                        });
                        //市事件结束
                        },
              yes: function(index){


                   checknewaddress();return false;

                    $.ajax({
                          type:"POST",
                          url:"flow.php?step=consignee",
                          data:$('#address_form').serialize(),
                          dataType:"JSON",
                          success: function(data){
                            if(data.error==12){
                                  window.location.href=data.url;
                            }
                            if($("input:radio[name='my_co_shipping']").length > 0){
                                      var check='';
                                }else{
                                     var check='checked';
                                }
                            var content=' <div class="row pay_label" style=" padding:2px 0; margin-bottom: 10px; margin-left: 0; margin-right: 0;cursor:pointer;" onclick="checkadd('+data.address_id+')" id="div'+data.address_id+'"><div class="col-md-6 check_box"  ><label class="radio radio-inline" style="margin-right:0; padding-top: 4px;" id="label'+data.address_id+'"  ><div class="iradio '+check+'"><input type="radio" name="my_co_shipping"  value="'+data.address_id+'"  id="address'+data.address_id+'"  style="position: absolute; opacity: 0;" '+check+'><ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins></div></label> '+data.province+data.city+data.district+data.address+'</div><div class="col-md-3">收件人：'+data.consignee+'</div><div class="col-md-3">联系电话：'+data.tel+'</div> </div>';

                            //console.log(data);
                             $("#address_h5").before(content);
                              if($("input:radio[name='my_co_shipping']").length > 0&& $(".pc_paylist").length>0){
                                        $(".order_ok").css("display","block");
                                  }else{
                                       $(".order_ok").css("display","none");
                                  }

                                 layer.close(index);
                                 //top.location.href = top.location.href;
                                  //window.location.href=window.location.href;
                                 // window.location.reload();
                                }
                               });
              },

            });
            });




    </script>
    <script type="text/javascript">

    //确认支付
   $('.order_ok').click(function(){
    var address=$("input[name='my_co_shipping']");
    var cart_id=[];
    $.each($(".pay_rec"),function(){
        cart_id.push($(this).val());
    });
    $.each(address,function(i){
      var id= $(this).attr("id");
        if($("#"+id).attr('checked')=='checked'){
          addressid=$("#"+id).val();

        }

    });

    $.ajax({
            type:"POST",
            url:"flow.php",
            data:{step:'new_done',address:addressid,cart_id:cart_id},
            success: function(data){
                    window.location.href="flow.php?step=pay_ok&order_id="+data;

                  }
                 });




      });
 </script>
 <script type="text/javascript">
  // 手机号码验证
  </script>
</body><!-- <body> -->

</html>
